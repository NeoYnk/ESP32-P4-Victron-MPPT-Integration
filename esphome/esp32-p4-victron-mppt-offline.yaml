# ESP32-P4 POE Ethernet - Victron MPPT VE.Direct Integration (OFFLINE Version)
# All components are local - no GitHub access required
#
# SETUP: Run ./setup-offline.sh once while online to download components
#
# This configuration provides:
# - Full MPPT sensor reading via m3_vedirect component (local)
# - Custom component for writing to register 0x2015 (Charge Current Limit)

substitutions:
  device_name: "victron-mppt"
  friendly_name: "Victron MPPT"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32-p4-evboard
  flash_size: 16MB
  framework:
    type: esp-idf
    version: recommended

# =============================================================================
# OFFLINE: All components loaded from local paths
# =============================================================================
external_components:
  # Victron VE.Direct component (local copy)
  # Download with: ./setup-offline.sh
  - source:
      type: local
      path: components
    components: [m3_vedirect]
  # Custom charge current limit component (local)
  - source:
      type: local
      path: custom_components
    components: [victron_charge_limit]

# Logging
logger:
  hardware_uart: UART0
  level: INFO

# Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# OTA Updates
ota:
  platform: esphome
  password: !secret ota_password

# Ethernet Configuration for ESP32-P4 with PoE
ethernet:
  type: IP101
  mdc_pin: GPIO31
  mdio_pin: GPIO52
  power_pin: GPIO51
  clk:
    mode: CLK_EXT_IN
    pin: GPIO50
  phy_addr: 1

# UART for VE.Direct
uart:
  id: uart_vedirect
  tx_pin: GPIO14
  rx_pin: GPIO15
  baud_rate: 19200

# =============================================================================
# VE.Direct Component for reading sensors
# =============================================================================

m3_vedirect:
  - id: vedirect_mppt
    uart_id: uart_vedirect
    name: "${friendly_name}"
    throttle: 5s
    textframe:
      auto_create_entities: false
    hexframe:
      auto_create_entities: false
      ping_timeout: 2min

# =============================================================================
# SENSORS - All readable MPPT values
# =============================================================================

sensor:
  # Battery/DC Channel
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: DC_CHANNEL1_VOLTAGE
        name: "${friendly_name} Battery Voltage"
      - register: DC_CHANNEL1_CURRENT
        name: "${friendly_name} Battery Current"
      - register: DC_CHANNEL1_POWER
        name: "${friendly_name} Battery Power"
      - register: CHARGER_VOLTAGE
        name: "${friendly_name} Charger Voltage"
      - register: CHARGER_CURRENT
        name: "${friendly_name} Charger Current"

  # Panel/PV
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: PANEL_VOLTAGE
        name: "${friendly_name} Panel Voltage"
      - register: PANEL_CURRENT
        name: "${friendly_name} Panel Current"
      - register: PANEL_POWER
        name: "${friendly_name} Panel Power"
      - register: PANEL_MAXIMUM_VOLTAGE
        name: "${friendly_name} Panel Max Voltage"
      - register: PANEL_MAXIMUM_CURRENT
        name: "${friendly_name} Panel Max Current"

  # Multi-Tracker (Tracker 1-4)
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: PANEL_VOLTAGE_1
        name: "${friendly_name} Tracker 1 Voltage"
      - register: PANEL_CURRENT_1
        name: "${friendly_name} Tracker 1 Current"
      - register: PANEL_POWER_1
        name: "${friendly_name} Tracker 1 Power"
      - register: PANEL_VOLTAGE_2
        name: "${friendly_name} Tracker 2 Voltage"
      - register: PANEL_CURRENT_2
        name: "${friendly_name} Tracker 2 Current"
      - register: PANEL_POWER_2
        name: "${friendly_name} Tracker 2 Power"

  # Load
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: LOAD_CURRENT
        name: "${friendly_name} Load Current"

  # Yield/Energy
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: YIELD_TODAY
        name: "${friendly_name} Yield Today"
      - register: YIELD_YESTERDAY
        name: "${friendly_name} Yield Yesterday"
      - register: MAXIMUM_POWER_TODAY
        name: "${friendly_name} Max Power Today"
      - register: MAXIMUM_POWER_YESTERDAY
        name: "${friendly_name} Max Power Yesterday"
      - register: USER_YIELD
        name: "${friendly_name} Total Yield"
      - register: SYSTEM_YIELD
        name: "${friendly_name} System Total Yield"

  # Temperature
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: BAT_TEMPERATURE
        name: "${friendly_name} Battery Temperature"
      - register: CHR_INTERNAL_TEMPERATURE
        name: "${friendly_name} Internal Temperature"

  # Other
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: BATTERY_RIPPLE_VOLTAGE
        name: "${friendly_name} Battery Ripple Voltage"
      - register: SOC
        name: "${friendly_name} State of Charge"
      - register: TTG
        name: "${friendly_name} Time to Go"
      - register: TIME_OF_DAY
        name: "${friendly_name} Time of Day"

  # Diagnostics
  - platform: uptime
    name: "${friendly_name} Uptime"

# =============================================================================
# TEXT SENSORS
# =============================================================================

text_sensor:
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: DEVICE_STATE
        name: "${friendly_name} Device State"
      - register: CHARGER_DEVICE_STATE
        name: "${friendly_name} Charger State"
      - register: MPPT_TRACKER_MODE
        name: "${friendly_name} MPPT Mode"
      - register: MPPT_TRACKER_MODE_1
        name: "${friendly_name} Tracker 1 Mode"
      - register: MPPT_TRACKER_MODE_2
        name: "${friendly_name} Tracker 2 Mode"
      - register: CHR_ERROR_CODE
        name: "${friendly_name} Error Code"
      - register: DEVICE_OFF_REASON
        name: "${friendly_name} Off Reason"
      - register: SERIAL_NUMBER
        name: "${friendly_name} Serial Number"
      - register: MODEL_NAME
        name: "${friendly_name} Model"
      - register: PRODUCT_ID
        name: "${friendly_name} Product ID"
      - register: APP_VER
        name: "${friendly_name} Firmware Version"

# =============================================================================
# BINARY SENSORS
# =============================================================================

binary_sensor:
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: SOLAR_ACTIVITY
        name: "${friendly_name} Solar Activity"
      - register: LOAD_OUTPUT_STATE
        name: "${friendly_name} Load Output"
      - register: BMS_PRESENT
        name: "${friendly_name} BMS Present"

# =============================================================================
# NUMBER - Writable values
# =============================================================================

number:
  # === CHARGE CURRENT LIMIT (Register 0x2015) ===
  # This is the CRITICAL writable register for dynamic current limiting
  # Uses custom component to write directly to 0x2015
  - platform: victron_charge_limit
    id: charge_current_limit
    name: "${friendly_name} Charge Current Limit"
    uart_id: uart_vedirect
    min_value: 0
    max_value: 100
    step: 0.1
    unit_of_measurement: "A"
    device_class: current
    icon: "mdi:current-dc"

  # Other writable values via m3_vedirect
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: BAT_MAX_CURRENT
        name: "${friendly_name} Max Battery Current (Persistent)"
      - register: BAT_ABSORPTION_VOLTAGE
        name: "${friendly_name} Absorption Voltage"
      - register: BAT_FLOAT_VOLTAGE
        name: "${friendly_name} Float Voltage"
      - register: BAT_EQUALISATION_VOLTAGE
        name: "${friendly_name} Equalisation Voltage"
      - register: BAT_STORAGE_VOLTAGE
        name: "${friendly_name} Storage Voltage"
      - register: BAT_ABSORPTION_LIMIT
        name: "${friendly_name} Absorption Time Limit"
      - register: BAT_BULK_LIMIT
        name: "${friendly_name} Bulk Time Limit"
      - register: REBULK_VOLTAGE_OFFSET
        name: "${friendly_name} Re-bulk Voltage Offset"
      - register: EQUALISATION_DURATION
        name: "${friendly_name} Equalisation Duration"
      - register: EQUALISATION_CURRENT_LEVEL
        name: "${friendly_name} Equalisation Current Level"
      - register: LOW_TEMP_CHARGE_CURRENT
        name: "${friendly_name} Low Temp Charge Current"
      - register: TAIL_CURRENT
        name: "${friendly_name} Tail Current"
      - register: BAT_LOW_TEMP_LEVEL
        name: "${friendly_name} Low Temperature Level"
      - register: BAT_TEMPERATURE_COMPENSATION
        name: "${friendly_name} Temp Compensation"
      - register: VOLTAGE_COMPENSATION
        name: "${friendly_name} Voltage Compensation"
      - register: AUTOMATIC_EQUALISATION_MODE
        name: "${friendly_name} Auto Equalisation Mode"
      - register: ALARM_LOW_VOLTAGE_SET
        name: "${friendly_name} Alarm Low Voltage Set"
      - register: ALARM_LOW_VOLTAGE_CLEAR
        name: "${friendly_name} Alarm Low Voltage Clear"
      - register: SHUTDOWN_LOW_VOLTAGE_SET
        name: "${friendly_name} Shutdown Low Voltage"

# =============================================================================
# SELECT - Enum configuration
# =============================================================================

select:
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: DEVICE_MODE
        name: "${friendly_name} Device Mode"
      - register: BAT_TYPE
        name: "${friendly_name} Battery Type"
      - register: BAT_VOLTAGE_SETTING
        name: "${friendly_name} Battery Voltage Setting"
      - register: RELAY_MODE
        name: "${friendly_name} Relay Mode"
      - register: REMOTE_INPUT_MODE_CONFIG
        name: "${friendly_name} Remote Input Mode"

# =============================================================================
# SWITCH - Boolean configuration
# =============================================================================

switch:
  - platform: m3_vedirect
    vedirect_id: vedirect_mppt
    vedirect_entities:
      - register: ADAPTIVE_MODE
        name: "${friendly_name} Adaptive Mode"
      - register: AUTO_EQUALISE_STOP_ON_VOLTAGE
        name: "${friendly_name} Auto Equalise Stop on Voltage"
      - register: BMS_PRESENT
        name: "${friendly_name} BMS Present Setting"
      - register: RELAY_CONTROL
        name: "${friendly_name} Relay Control"
      - register: ALARM_BUZZER
        name: "${friendly_name} Alarm Buzzer"
      - register: BLE_MODE
        name: "${friendly_name} BLE Mode"

# =============================================================================
# BUTTON
# =============================================================================

button:
  - platform: restart
    name: "${friendly_name} Restart ESP"
